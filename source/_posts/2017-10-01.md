---
title: KeyPath æœ€ä½³å®è·µ
date: 2017-10-01 17:01
---

Swift 4.0 å¸¦æ¥çš„ä¸€ä¸ªæ–°åŠŸèƒ½å°±æ˜¯ Smart KeyPathï¼Œä¹‹å‰åœ¨ Twitter ä¸Šçœ‹åˆ° Chris Eidhof å¤§ç¥åœ¨å¾é›† KeyPath çš„ç”¨æ³•ã€‚

æˆ‘ä¹Ÿæœé›†äº†ä¸€ä¸‹ï¼Œå½“ä½œæ˜¯ä¸€æ¬¡æ€»ç»“ï¼Œè¿™é‡Œé¢çš„æŠ€å·§å…¶å®å¤§éƒ¨åˆ†éƒ½å¾ˆéš¾åœ¨å®è·µä¸­ç”¨ä¸Šï¼Œåªæ˜¯å¥½ç©æœ‰è¶£è€Œå·²ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§å¯å‘å§ã€‚

<!--more-->

## ç±»å‹å®‰å…¨çš„ Query API

> å‡ºå¤„ï¼š[Kuery](https://github.com/kishikawakatsumi/Kuery)

åˆ©ç”¨äº† KeyPath ç±»å‹å®‰å…¨çš„ç‰¹æ€§ï¼Œæä¾›äº†ç±»å‹å®‰å…¨çš„ Query APIã€‚ç›®å‰å”¯ä¸€åšå‡ºæ¥çš„ä¸€ä¸ªæˆå“æ˜¯ Kuery åº“ï¼Œç±»å‹å®‰å…¨çš„ CoreData æŸ¥è¯¢ APIï¼Œç›¸åŒçš„æ–¹å¼ä¹Ÿå¯ä»¥ä¸º Realmï¼ŒSQLite ç­‰æ•°æ®åº“æœåŠ¡ï¼Œä¸‹é¢æ˜¯å®ƒçš„ä½¿ç”¨èŒƒä¾‹ï¼š

```swift
Query(Person.self).filter(\.name != "Katsumi")
Query(Person.self).filter(\.age > 20)
```

å…¶å®æˆ‘ä¸ªäººè§‰å¾—è¿™ä¸ª API è¿˜å¯ä»¥å†ç®€åŒ–ï¼š

```swift
Query.filter(\Person.name != "Katsumi")
// æˆ–
Query<Person>.filter(\.name != "Katsumi")
```

è¿™ä¸ªåº“çš„åŸç†æ˜¯æ“ä½œç¬¦é‡è½½ï¼Œå¤§å®¶çœ‹ä¸€ä¸‹å‡½æ•°å£°æ˜å°±èƒ½å¤§æ¦‚ç†è§£äº†ï¼š

```swift
public func == <ManagedObject: NSManagedObject, Property: Equatable>(
    lhs: KeyPath<ManagedObject, Property?>,
    rhs: Property?) 
    -> NSPredicate<ManagedObject> { ... }
```

å…·ä½“å®ç°çš„æ—¶å€™ä½¿ç”¨äº† `KeyPath` çš„å±æ€§ `_kvcKeyPathString`ï¼Œè¿™æ˜¯ä¸ºäº†å…¼å®¹ ObjectiveC çš„ KVC è€Œå­˜åœ¨çš„å±æ€§ï¼Œå®ƒå¹¶éæ˜¯ä¸€ä¸ªå…¬å¼€çš„ APIï¼Œåœ¨æ­£å¼æ–‡æ¡£æˆ– Xcode é‡Œæ˜¯æŸ¥ä¸åˆ°è¿™ä¸ªå±æ€§çš„ï¼Œå…·ä½“çš„ç»†èŠ‚æˆ‘ä»¬å¯ä»¥åœ¨ [GitHub](https://github.com/apple/swift/blob/master/stdlib/public/core/KeyPath.swift) ä¸Šçœ‹åˆ°ã€‚

è™½ç„¶æŸ¥ä¸åˆ°ï¼Œä½†ç›®å‰ä»£ç é‡Œæ˜¯å¯ä»¥ä½¿ç”¨è¿™ä¸ªå±æ€§çš„ï¼ˆXcode 9.0ï¼ŒSwift 4.0ï¼‰ï¼ŒKuery çš„ä½œè€…ä¹Ÿå» Rader é‡Œ[åé¦ˆäº†å°†è¿™ä¸ª API æ­£å¼åŒ–çš„éœ€æ±‚](https://bugs.swift.org/browse/SR-5220)ï¼Œä¸è¿‡æš‚æ—¶è¿˜æ˜¯ä¸æ¨èå¤§å®¶ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚

## ReadOnly çš„ Class

> å‡ºå¤„ï¼š[Chris Eidhof](https://twitter.com/chriseidhof/status/907891015973003264)

```swift
final class ReadOnly<T> {
    private let value: T
    
    init(_ value: T) {
        self.value = value
    }
    
    subscript<P>(keyPath: KeyPath<T, P>) -> P {
        return value[keyPath: keyPath]
    }
}

import UIKit

let textField = UITextField()

let readOnlyTextField = ReadOnly(textFiled)

r[\.text]          // nil
r[\.text] = "Test" // ç¼–è¯‘é”™è¯¯
```

è¿™æ˜¯ä¸ªå¾ˆå¥½ç©çš„å®ç°ï¼Œæ­£å¸¸æ¥è¯´æˆ‘ä»¬å®ç°åªè¯»ï¼Œéƒ½æ˜¯ä½¿ç”¨æ¥å£çš„æƒé™è®¾è®¡ï¼Œä¾‹å¦‚ `private(set)` ä¹‹ç±»çš„åšæ³•ï¼Œä½†è¿™é‡Œåˆ©ç”¨äº† `KeyPath` æ— æ³•ä¿®æ”¹å€¼çš„ç‰¹æ€§å®ç°äº†è¿™ä¸€ä¸ªåŠŸèƒ½ï¼Œå¼ºè¡Œä¿®æ”¹å°±ä¼šåƒä¸Šé¢é‚£æ ·åœ¨ç¼–è¯‘æ—¶å°±æŠ›å‡ºé”™è¯¯ã€‚

ä¸è¿‡è¿™ç§åªè¯»æƒé™çš„é¢—ç²’åº¦å¤ªå¤§ï¼Œåªèƒ½ç»†è‡´åˆ°æ•´ä¸ªç±»å®ä¾‹ï¼Œè€Œä¸èƒ½é’ˆå¯¹æ¯ä¸€ä¸ªå±æ€§ã€‚è€Œä¸”æˆ‘åœ¨å®è·µä¸­ä¹Ÿæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ä½¿ç”¨åœºæ™¯ã€‚

## å–ä»£ Selector çš„æŠ½è±¡

è¿™æ˜¯æˆ‘åœ¨[æ³Šå­¦ç½‘](https://boxueio.com)çš„ä¼šå‘˜ç¾¤é‡Œå¶ç„¶çœ‹åˆ°çš„ï¼Œ11 è¯´ Swift 4 é‡Œä¹Ÿæœ‰åŸç”Ÿçš„ Selectorã€‚ä»”ç»†æƒ³äº†ä¸€ä¸‹ï¼Œå°±åªæœ‰ KeyPath äº†ï¼Œå®ç°å‡ºæ¥å¤§æ¦‚ä¼šæ˜¯è¿™æ ·ï¼š

```swift
// å®šä¹‰
extension UIControl {
    func addTarget<T>(
        _ target: T,
        action: KeyPath<T, (UIControl) -> ()>,
        for controlEvents: UIControlEvents)
    { ... }
}

// è°ƒç”¨
button.addTarget(self, action: \ViewController.didTapButton, for: .touchUpInside)
```

è¿™æ ·å¤„ç†çš„è¯ï¼Œ`didTapButton` æ–¹æ³•ç”šè‡³éƒ½ä¸éœ€è¦ä¾èµ–äº Objective-C çš„ runtimeï¼Œåªè¦èƒ½ç”¨ KeyPath æŠŠæ–¹æ³•å–å‡ºæ¥å°±è¡Œäº†ã€‚

ä½†å®é™…è¯•äº†ä¸€ä¸‹ä¹‹åï¼Œå‘ç°å¹¶ä¸å¯è¡Œï¼Œæˆ‘å°±å»ç¿»äº†ä¸€ä¸‹ [KeyPath çš„ææ¡ˆ](https://github.com/apple/swift-evolution/blob/master/proposals/0161-key-paths.md)ï¼š

> We think the disambiguating benefits of the escape-sigil would greatly benefit function type references, but such considerations are outside the scope of this proposal.

å‰åŠå¥å…¶å®æˆ‘ä¸å¤ªç†è§£ï¼Œä½†æ•´å¥è¯è¯»ä¸‹æ¥ï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯å®ç°èµ·æ¥å¾ˆå¤æ‚ï¼Œä¼šä¸å¦å¤–çš„ä¸€ä¸ªé—®é¢˜äº¤ç»‡åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥æš‚æ—¶ä¸åœ¨è¿™ä¸ªææ¡ˆé‡Œå¤„ç†ã€‚æˆ‘å»ç¿»[é‚®ä»¶åˆ—è¡¨](https://lists.swift.org/pipermail/swift-evolution-announce/2017-April/000356.html)çš„æ—¶å€™ç»ˆäºæ‰¾åˆ°äº†æƒ³è¦çš„ç­”æ¡ˆï¼š

> for unapplied method references, bringing the two closely-related features into syntactic alignment over time and providing an opportunity to stage in the important but currently-source-breaking changes accepted in SE-0042 <https://github.com/apple/swift-evolution/blob/master/proposals/0042-flatten-method-types.md>.

KeyPath æŒ‡å‘æ–¹æ³•çš„è¿™ä¸ª Featureï¼Œå’Œ SE-0042 å¾ˆæ¥è¿‘ï¼Œæ‰€ä»¥åé¢ä¼šä¸¤ä¸ªåŠŸèƒ½ä¸€èµ·å®ç°ã€‚

## çŠ¶æ€å…±äº«çš„å€¼ç±»å‹

> å‡ºå¤„ï¼š[Swift Talk #61](https://talk.objc.io/episodes/S01E61-mutable-shared-structs-part-1) | [Swift Talk #62](https://talk.objc.io/episodes/S01E62-mutable-shared-structs-part-2)
 
è¿™åº”è¯¥ç®—æ˜¯è¿™ç¯‡æ–‡ç« é‡Œé¢æœ€ Tricky ä½†æ˜¯ä¹Ÿæœ€æœ‰è¶£çš„ä¸€ä¸ªç”¨æ³•äº†ï¼Œæˆ‘åœ¨çœ‹ Swift Talk çš„æ—¶å€™ï¼Œä»‹ç»çš„ä¸€ç§çŠ¶æ€å…±äº«çš„å€¼ç±»å‹ï¼Œç›´æ¥ä¸Šä»£ç ï¼š

```swift
final class Var<A> {
    private var _get: () -> A
    private var _set: (A) -> ()
    
    var value: A {
        get { return _get()  }
        set { _set(newValue) }
    }
    
    init(_ value: A) {
        var x = value
        _get = { x }
        _set = { x = $0 }
    }
    
    private init(get: @escaping () -> A, set: @escaping (A) -> ()) {
        _get = get
        _set = set
    }
    
    subscript<Part>(_ kp: WritableKeyPath<A, Part>) -> Var<Part> {
        return Var<Part>(
            get: { self.value[keyPath: kp]      },
            set: { self.value[keyPath: kp] = $0 })
    }
}
```

çœ‹å®Œä»£ç å¯èƒ½æœ‰ç‚¹éš¾ç†è§£ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹ç¤ºä¾‹ç„¶åå†è§£é‡Šï¼š

```swift
var john = Person(name: "John", age: 11)

let johnVar = Var(john)
let ageVar = johnVar[\.age]

print(johnVar.value.age) // 11
print(ageVar.value)      // 11

ageVar.value = 22

print(johnVar.value.age) // 22
print(ageVar.value)      // 22

johnVar.value.age = 33

print(johnVar.value.age) // 33
print(ageVar.value)      // 33
```

ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ° `ageVar` ä» `johnVar` åˆ†å‰²å‡ºæ¥ä¹‹åï¼Œå®ƒçš„çŠ¶æ€ä¾æ—§è·Ÿ `johnVar` ä¿æŒä¸€è‡´ï¼Œè¿™æ˜¯å› ä¸º `Var` çš„ init æ–¹æ³•é‡Œä½¿ç”¨ block æ•è·äº† `x` è¿™ä¸ªå˜é‡ï¼Œä¹Ÿå°±ç›¸å½“äºä½œä¸º inout å‚æ•°ä¼ å…¥äº†è¿›å»ï¼Œè¿™ä¸ªæ—¶å€™ `x` ä¼šå­˜æ”¾åœ¨å †åŒºã€‚

å¹¶ä¸”ä½¿ç”¨ subscript ç”Ÿæˆäº† `ageVar` ä¹‹åï¼Œ`ageVar` ä½¿ç”¨çš„ init çš„æ–¹æ³•åªæ˜¯åœ¨åŸæœ¬çš„ `_get` å’Œ `_set` æ–¹æ³•å¤–é¢å†åŒ…äº†ä¸€å±‚ï¼Œæ‰€ä»¥ `ageVar` ä¿®æ”¹å€¼çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä½¿ç”¨äº†åŸæœ¬ `johnVar` ä¸€æ ·çš„ `_set`ï¼Œä¿®æ”¹äº†æœ€åˆ `johnVar` åˆå§‹åŒ–æ—¶ä½¿ç”¨çš„ `x`ã€‚æ¢å¥è¯è¯´ï¼Œ`ageVar` å’Œ `johnVar` ä½¿ç”¨çš„éƒ½æ˜¯å †åŒºé‡ŒåŒä¸€ä¸ª `x`ã€‚å¬ç€æ˜¯ä¸æ˜¯å¾ˆåƒ classï¼ŸğŸ¤”

æ›´å…·ä½“çš„ç»†èŠ‚ï¼Œå¤§å®¶å¯ä»¥å»çœ‹ Swift Talkã€‚

## ç»“å°¾

> KeyPath is incredibly important in Cocoa Development. And this is they let us reason about the structure of our types apart from any specific instance in a way that's far more constrained than a closure.
> 
> â€”â€” What's New in Foundation Â· WWDC 2017 Â· Session 212

ä¸Šé¢è¿™æ®µè¯æ‘˜å½•è‡ªä»Šå¹´ WWDC çš„ What's New in Foundationï¼Œç®€å•çš„ç¿»è¯‘å°±æ˜¯ `KeyPath å¯¹äº Cocoa çš„ä½¿ç”¨éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒå¯ä»¥é€šè¿‡ç±»å‹çš„ç»“æ„ï¼Œå»è·å–ä»»æ„ä¸€ä¸ªå®ä¾‹çš„ç›¸åº”å±æ€§ï¼Œè€Œä¸”è¿™ç§æ–¹å¼è¿œæ¯”é—­åŒ…æ›´åŠ ç®€å•å’Œç´§å‡‘ã€‚`






